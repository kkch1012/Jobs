[1mdiff --git a/backend/app/routers/scheduler.py b/backend/app/routers/scheduler.py[m
[1mindex 6dcdd18..226af71 100644[m
[1m--- a/backend/app/routers/scheduler.py[m
[1m+++ b/backend/app/routers/scheduler.py[m
[36m@@ -1,7 +1,8 @@[m
 from fastapi import APIRouter, Depends, HTTPException[m
 from app.services.scheduler import get_scheduler_status, start_scheduler, stop_scheduler[m
[31m-from app.utils.dependencies import get_current_user[m
[32m+[m[32mfrom app.utils.dependencies import get_current_user, get_optional_current_user[m[41m[m
 from app.models.user import User[m
[32m+[m[32mfrom typing import Optional[m[41m[m
 [m
 router = APIRouter(prefix="/scheduler", tags=["Scheduler"])[m
 [m
[36m@@ -51,12 +52,9 @@[m [mdef stop():[m
     description="ë§¤ì¼ ì•„ì¹¨ 8ì‹œì— ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ìœ ì‚¬ë„ ê³„ì‚° ë°°ì¹˜ ì‘ì—…ì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."[m
 )[m
 def run_similarity_batch_manual([m
[31m-    current_user: User = Depends(get_current_user)[m
[32m+[m[32m    current_user: Optional[User] = Depends(get_optional_current_user)[m[41m[m
 ):[m
     """ìœ ì‚¬ë„ ê³„ì‚° ë°°ì¹˜ ì‘ì—… ìˆ˜ë™ ì‹¤í–‰"""[m
[31m-    # ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (í•„ìš”ì‹œ)[m
[31m-    # if not current_user.is_admin:[m
[31m-    #     raise HTTPException(status_code=403, detail="ê´€ë¦¬ìë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")[m
     [m
     try:[m
         from app.services.similarity_scores import auto_compute_all_users_similarity[m
[36m@@ -82,12 +80,9 @@[m [mdef run_similarity_batch_manual([m
     description="ë§¤ì¼ ì•„ì¹¨ 8ì‹œì— ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ì¼ê°„ ìŠ¤í‚¬ í†µê³„ ìƒì„± ì‘ì—…ì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."[m
 )[m
 def run_daily_stats_manual([m
[31m-    current_user: User = Depends(get_current_user)[m
[32m+[m[32m    current_user: Optional[User] = Depends(get_optional_current_user)[m[41m[m
 ):[m
     """ì¼ê°„ ìŠ¤í‚¬ í†µê³„ ìƒì„± ì‘ì—… ìˆ˜ë™ ì‹¤í–‰"""[m
[31m-    # ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (í•„ìš”ì‹œ)[m
[31m-    # if not current_user.is_admin:[m
[31m-    #     raise HTTPException(status_code=403, detail="ê´€ë¦¬ìë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")[m
     [m
     try:[m
         from app.services.weekly_stats_service import WeeklyStatsService[m
[36m@@ -124,12 +119,9 @@[m [mdef run_daily_stats_manual([m
     description="ë§¤ì¼ ì•„ì¹¨ 8ì‹œì— ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  ë°°ì¹˜ ì‘ì—…(ìœ ì‚¬ë„ ê³„ì‚° + ì¼ê°„ í†µê³„ ìƒì„±)ì„ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."[m
 )[m
 def run_daily_batch_manual([m
[31m-    current_user: User = Depends(get_current_user)[m
[32m+[m[32m    current_user: Optional[User] = Depends(get_optional_current_user)[m[41m[m
 ):[m
     """ë§¤ì¼ ì•„ì¹¨ ë°°ì¹˜ ì‘ì—… ìˆ˜ë™ ì‹¤í–‰"""[m
[31m-    # ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (í•„ìš”ì‹œ)[m
[31m-    # if not current_user.is_admin:[m
[31m-    #     raise HTTPException(status_code=403, detail="ê´€ë¦¬ìë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")[m
     [m
     try:[m
         from app.services.similarity_scores import auto_compute_all_users_similarity[m
[1mdiff --git a/backend/app/routers/visualization.py b/backend/app/routers/visualization.py[m
[1mindex ea68cf2..a880bd2 100644[m
[1m--- a/backend/app/routers/visualization.py[m
[1m+++ b/backend/app/routers/visualization.py[m
[36m@@ -1,448 +1,565 @@[m
[31m-from fastapi import APIRouter, Depends, Query, HTTPException[m
[31m-from sqlalchemy.orm import Session[m
[31m-from sqlalchemy import func, and_, or_[m
[31m-from typing import List, Dict, Any, Optional[m
[31m-from starlette.responses import JSONResponse[m
[31m-from app.database import get_db[m
[31m-from app.models.job_post import JobPost[m
[31m-from app.models.job_required_skill import JobRequiredSkill[m
[31m-from app.schemas.visualization import WeeklySkillStat, ResumeSkillComparison[m
[31m-from app.utils.dependencies import get_current_user[m
[31m-from app.models.user_skill import UserSkill[m
[31m-from app.models.user import User[m
[31m-from app.models.certificate import Certificate[m
[31m-from app.services.gap_model import perform_gap_analysis_visualization[m
[31m-from app.services.weekly_stats_service import WeeklyStatsService[m
[31m-from app.models.weekly_skill_stat import WeeklySkillStat as WeeklySkillStatModel[m
[31m-from app.services.roadmap_model import get_roadmap_recommendations[m
[31m-[m
[31m-router = APIRouter(prefix="/visualization", tags=["Visualization"])[m
[31m-[m
[31m-@router.get([m
[31m-    "/weekly_skill_frequency",[m
[31m-    operation_id="weekly_skill_frequency",[m
[31m-    summary="ì§ë¬´ë³„ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ ì¡°íšŒ",[m
[31m-    description="""[m
[31m-ì„ íƒí•œ **ì§ë¬´ëª…(`job_name`)**ê³¼ ë¶„ì„ í•„ë“œ(`field`)ì— ëŒ€í•´, ìµœê·¼ ì±„ìš©ê³µê³ ì—ì„œ ì¶”ì¶œëœ **ê¸°ìˆ /í‚¤ì›Œë“œì˜ ì£¼ë³„ ë“±ì¥ ë¹ˆë„**ë¥¼ ì§‘ê³„í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[31m-[m
[31m-- **ì§ë¬´ëª…**ì€ ë“±ë¡ëœ ì§ë¬´ í…Œì´ë¸”(`JobRequiredSkill`)ì˜ `job_name` ê°’ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.[m
[31m-- ì…ë ¥ëœ `job_name`ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° 404 ì—ëŸ¬ê°€ ë°˜í™˜ë©ë‹ˆë‹¤.[m
[31m-- ë¶„ì„ ëŒ€ìƒ í•„ë“œ(`field`)ëŠ” ì•„ë˜ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•˜ë©°, í•´ë‹¹ í•„ë“œëŠ” ì±„ìš©ê³µê³ (`JobPost`) ëª¨ë¸ì— ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.[m
[31m-    - tech_stack, qualifications, preferences, required_skills, preferred_skills[m
[31m-- ë°˜í™˜ ë°ì´í„°ëŠ” [ì—°ë„, ì£¼ì°¨, ìŠ¤í‚¬, ë¹ˆë„] í˜•íƒœì˜ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.[m
[31m-- ì›Œë“œí´ë¼ìš°ë“œ, íŠ¸ë Œë“œ ì°¨íŠ¸, í†µê³„ ë“±ì— í™œìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.[m
[31m-[m
[31m-**ì‘ë‹µ ì˜ˆì‹œ:**[m
[31m-```json[m
[31m-[[m
[31m-  { "year": 2025, "week": 28, "skill": "Python", "count": 12 },[m
[31m-  { "year": 2025, "week": 28, "skill": "SQL", "count": 7 },[m
[31m-  { "year": 2025, "week": 27, "skill": "Java", "count": 5 }[m
[31m-][m
[31m-""",[m
[31m-    response_model=List[WeeklySkillStat][m
[31m-)[m
[31m-def weekly_skill_frequency([m
[31m-    job_name: str = Query(..., description="ì¡°íšŒí•  ì§ë¬´ëª… (ì˜ˆ: ë°±ì—”ë“œ ê°œë°œì)"),[m
[31m-    field: str = Query([m
[31m-        "tech_stack",[m
[31m-        enum=[[m
[31m-            "tech_stack", "qualifications", "preferences",[m
[31m-            "required_skills", "preferred_skills"[m
[31m-        ],[m
[31m-        description="ë¶„ì„ ëŒ€ìƒ í•„ë“œëª… (ì±„ìš©ê³µê³  ëª¨ë¸ì— ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ ì¤‘ ì„ íƒ)"[m
[31m-    ),[m
[31m-    db: Session = Depends(get_db)[m
[31m-):[m
[31m-    # 1. ì§ë¬´ëª… â†’ id ë§¤í•‘[m
[31m-    job_role = db.query(JobRequiredSkill).filter(JobRequiredSkill.job_name == job_name).first()[m
[31m-    if not job_role:[m
[31m-        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì§ë¬´ëª…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")[m
[31m-    job_role_id = job_role.id[m
[31m-[m
[31m-    # 2. í•´ë‹¹ ì§ë¬´idë¡œ JobPost í•„í„°ë§ & ì£¼ë³„ ì§‘ê³„ (ë§Œë£Œë˜ì§€ ì•Šì€ ê³µê³ ë§Œ)[m
[31m-    posts = db.query([m
[31m-        JobPost.posting_date,[m
[31m-        getattr(JobPost, field)[m
[31m-    ).filter([m
[31m-        and_([m
[31m-            JobPost.job_required_skill_id == job_role_id,[m
[31m-            or_(JobPost.is_expired.is_(None), JobPost.is_expired.is_(False))[m
[31m-        )[m
[31m-    ).all()[m
[31m-[m
[31m-    # 3. ì£¼ë³„ë¡œ ê¸°ìˆ  í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ISO ì£¼ì°¨ ì‚¬ìš©)[m
[31m-    from collections import Counter, defaultdict[m
[31m-    from datetime import datetime[m
[31m-    week_skill_counter = defaultdict(Counter)[m
[31m-    for row in posts:[m
[31m-        posting_date, field_value = row.posting_date, row[1][m
[31m-        [m
[31m-        # ISO ì£¼ì°¨ ê³„ì‚°[m
[31m-        week_number = posting_date.isocalendar()[1]  # ISO ì£¼ì°¨[m
[31m-        posting_date_only = posting_date.date()  # ë‚ ì§œë§Œ ì¶”ì¶œ[m
[31m-        [m
[31m-        skills = [][m
[31m-        [m
[31m-        # í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬[m
[31m-        if field == "tech_stack":[m
[31m-            # tech_stackì€ ë¬¸ìì—´ í•„ë“œ[m
[31m-            if isinstance(field_value, str) and field_value.strip():[m
[31m-                skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[31m-        else:[m
[31m-            # required_skills, preferred_skills, main_tasks_skillsëŠ” JSONB í•„ë“œ[m
[31m-            if isinstance(field_value, list):[m
[31m-                skills = [str(skill).strip() for skill in field_value if skill][m
[31m-            elif isinstance(field_value, str) and field_value.strip():[m
[31m-                # JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„[m
[31m-                try:[m
[31m-                    import json[m
[31m-                    parsed = json.loads(field_value)[m
[31m-                    if isinstance(parsed, list):[m
[31m-                        skills = [str(skill).strip() for skill in parsed if skill][m
[31m-                except:[m
[31m-                    # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬[m
[31m-                    skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[31m-        [m
[31m-        if skills:[m
[31m-            week_skill_counter[(week_number, posting_date_only)].update(skills)[m
[31m-[m
[31m-    # 4. ê²°ê³¼ ì‘ë‹µ[m
[31m-    response = [][m
[31m-    for (week, date_val), counter in week_skill_counter.items():[m
[31m-        for skill, count in counter.items():[m
[31m-            response.append(WeeklySkillStat([m
[31m-                week=week, date=date_val, skill=skill, count=count[m
[31m-            ))[m
[31m-    # count ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬[m
[31m-    response = sorted(response, key=lambda x: x.count, reverse=True)[m
[31m-    return response[m
[31m-[m
[31m-@router.get([m
[31m-    "/resume_vs_job_skill_trend",[m
[31m-    summary="ë‚´ ì´ë ¥ì„œ vs ì§ë¬´ë³„ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ ë¹„êµ",[m
[31m-    description="ë‚´ ì´ë ¥ì„œ(ë³´ìœ  ìŠ¤í‚¬)ì™€ ì„ íƒí•œ ì§ë¬´ì˜ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ í†µê³„ë¥¼ ë¹„êµí•˜ì—¬ ê°•ì (ë³´ìœ )/ì•½ì (ë¯¸ë³´ìœ ) ìŠ¤í‚¬ì„ ì‹œê°í™”í•  ìˆ˜ ìˆë„ë¡ ë°˜í™˜í•©ë‹ˆë‹¤.",[m
[31m-    response_model=List[ResumeSkillComparison][m
[31m-)[m
[31m-async def resume_vs_job_skill_trend([m
[31m-    job_name: str = Query(..., description="ë¹„êµí•  ì§ë¬´ëª… (ì˜ˆ: ë°±ì—”ë“œ ê°œë°œì)"),[m
[31m-    field: str = Query([m
[31m-        "tech_stack",[m
[31m-        enum=[[m
[31m-            "tech_stack", "qualifications", "preferences",[m
[31m-            "required_skills", "preferred_skills"[m
[31m-        ],[m
[31m-        description="ë¶„ì„ ëŒ€ìƒ í•„ë“œëª… (ì±„ìš©ê³µê³  ëª¨ë¸ì— ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ ì¤‘ ì„ íƒ)"[m
[31m-    ),[m
[31m-    db: Session = Depends(get_db),[m
[31m-    current_user: User = Depends(get_current_user)[m
[31m-):[m
[31m-    # 1. ë‚´ ì´ë ¥ì„œ(ë³´ìœ  ìŠ¤í‚¬) ì¡°íšŒ[m
[31m-    user_skills = db.query(UserSkill).filter(UserSkill.user_id == current_user.id).all()[m
[31m-    my_skill_set = set()[m
[31m-    for us in user_skills:[m
[31m-        if hasattr(us, 'skill') and us.skill and hasattr(us.skill, 'name'):[m
[31m-            my_skill_set.add(us.skill.name)[m
[31m-        elif hasattr(us, 'skill_name'):[m
[31m-            my_skill_set.add(us.skill_name)[m
[31m-[m
[31m-    # 2. ì§ë¬´ë³„ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ ë°ì´í„° ì¡°íšŒ (ê¸°ì¡´ í•¨ìˆ˜ ì¬í™œìš©)[m
[31m-    job_role = db.query(JobRequiredSkill).filter(JobRequiredSkill.job_name == job_name).first()[m
[31m-    if not job_role:[m
[31m-        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì§ë¬´ëª…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")[m
[31m-    job_role_id = job_role.id[m
[31m-    posts = db.query([m
[31m-        JobPost.posting_date,[m
[31m-        getattr(JobPost, field)[m
[31m-    ).filter([m
[31m-        and_([m
[31m-            JobPost.job_required_skill_id == job_role_id,[m
[31m-            or_(JobPost.is_expired.is_(None), JobPost.is_expired.is_(False))[m
[31m-        )[m
[31m-    ).all()[m
[31m-    from collections import Counter, defaultdict[m
[31m-    from datetime import datetime[m
[31m-    week_skill_counter = defaultdict(Counter)[m
[31m-    for row in posts:[m
[31m-        posting_date, field_value = row.posting_date, row[1][m
[31m-        [m
[31m-        # ISO ì£¼ì°¨ì™€ ë‚ ì§œ ê³„ì‚°[m
[31m-        week_number = posting_date.isocalendar()[1]  # ISO ì£¼ì°¨[m
[31m-        posting_date_only = posting_date.date()  # ë‚ ì§œë§Œ ì¶”ì¶œ[m
[31m-        [m
[31m-        skills = [][m
[31m-        [m
[31m-        # í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬[m
[31m-        if field == "tech_stack":[m
[31m-            # tech_stackì€ ë¬¸ìì—´ í•„ë“œ[m
[31m-            if isinstance(field_value, str) and field_value.strip():[m
[31m-                skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[31m-        else:[m
[31m-            # required_skills, preferred_skills, main_tasks_skillsëŠ” JSONB í•„ë“œ[m
[31m-            if isinstance(field_value, list):[m
[31m-                skills = [str(skill).strip() for skill in field_value if skill][m
[31m-            elif isinstance(field_value, str) and field_value.strip():[m
[31m-                # JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„[m
[31m-                try:[m
[31m-                    import json[m
[31m-                    parsed = json.loads(field_value)[m
[31m-                    if isinstance(parsed, list):[m
[31m-                        skills = [str(skill).strip() for skill in parsed if skill][m
[31m-                except:[m
[31m-                    # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬[m
[31m-                    skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[31m-        [m
[31m-        # ìŠ¤í‚¬ëª… ê¸¸ì´ ì œí•œ (500ì)[m
[31m-        if skills:[m
[31m-            limited_skills = [][m
[31m-            for skill in skills:[m
[31m-                if len(skill) > 500:[m
[31m-                    skill = skill[:497] + "..."  # 500ìë¡œ ì œí•œ[m
[31m-                limited_skills.append(skill)[m
[31m-            week_skill_counter[(week_number, posting_date_only)].update(limited_skills)[m
[31m-    # 3. ê°•ì /ì•½ì  ë¹„êµ ë° ì‘ë‹µ ìƒì„±[m
[31m-    response = [][m
[31m-    for (week, date_val), counter in week_skill_counter.items():[m
[31m-        for skill, count in counter.items():[m
[31m-            status = "ê°•ì " if skill in my_skill_set else "ì•½ì "[m
[31m-            response.append(ResumeSkillComparison([m
[31m-                skill=skill, count=count, status=status, week=week, date=date_val[m
[31m-            ))[m
[31m-    return response[m
[31m-[m
[31m-@router.get("/gap-analysis", response_class=JSONResponse,[m
[31m-    summary="GPT ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„",[m
[31m-    description="""[m
[31m-ì‚¬ìš©ìì˜ ì´ë ¥ ì •ë³´ì™€ ì„ íƒí•œ ì§ë¬´(ì¹´í…Œê³ ë¦¬)ë¥¼ ë°”íƒ•ìœ¼ë¡œ GPT(OpenRouter) ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.\n[m
[31m-- ë¶„ì„ ê²°ê³¼ëŠ” ìì—°ì–´ ì„¤ëª…(gap_result)ê³¼ ë¶€ì¡± ì—­ëŸ‰ Top 5 ë¦¬ìŠ¤íŠ¸(top_skills)ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.\n[m
[31m-- í”„ë¡ íŠ¸ì—”ë“œëŠ” gap_resultë¥¼ ì¶œë ¥ìš©ìœ¼ë¡œ, top_skillsë¥¼ íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë“± ë‚´ë¶€ í™œìš©ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n[m
[31m-- LLM í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë°˜í™˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.[m
[31m-"""[m
[31m-)[m
[31m-def gap_analysis_endpoint([m
[31m-    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[31m-    db: Session = Depends(get_db),[m
[31m-    current_user: User = Depends(get_current_user)[m
[31m-):[m
[31m-    """[m
[31m-    ì‚¬ìš©ìì˜ ì´ë ¥ ì •ë³´ì™€ ì„ íƒí•œ ì§ë¬´ë¥¼ ë°”íƒ•ìœ¼ë¡œ LLM ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.[m
[31m-    ë¶„ì„ ê²°ê³¼ëŠ” ìì—°ì–´ ì„¤ëª…ê³¼ ë¶€ì¡± ì—­ëŸ‰ Top 5 ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.[m
[31m-    """[m
[31m-    try:[m
[31m-        user_id = getattr(current_user, "id", None)[m
[31m-        if user_id is None:[m
[31m-            raise HTTPException(status_code=400, detail="ìœ ì € IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[31m-        if hasattr(user_id, "__int__"):[m
[31m-            user_id = int(user_id)[m
[31m-        if not isinstance(user_id, int):[m
[31m-            raise HTTPException(status_code=400, detail="ìœ ì € IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[31m-        result = perform_gap_analysis_visualization(user_id, category, db=db)[m
[31m-[m
[31m-        # 1. í”„ë¡ íŠ¸ì— ë³´ì—¬ì¤„ ìì—°ì–´ ê²°ê³¼[m
[31m-        gap_result = result["gap_result"][m
[31m-[m
[31m-        # 2. ë‚´ë¶€ To-Do ì‹œìŠ¤í…œìœ¼ë¡œ ë³´ë‚¼ Top 5 ìŠ¤í‚¬[m
[31m-        top_skills = result["top_skills"][m
[31m-        # ì˜ˆì‹œ: ì¶”í›„ ë¹„ë™ê¸°ë¡œ ë³´ë‚´ê±°ë‚˜ DBì— ì €ì¥[m
[31m-        # send_to_todo(user_id, top_skills)[m
[31m-[m
[31m-        return {[m
[31m-            "gap_result": gap_result,      # í”„ë¡ íŠ¸ì— ì¶œë ¥í•  ìì—°ì–´[m
[31m-            "top_skills": top_skills       # í”„ë¡ íŠ¸ê°€ íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ë¡œ í™œìš© ê°€ëŠ¥[m
[31m-        }[m
[31m-[m
[31m-    except ValueError as e:[m
[31m-        raise HTTPException(status_code=404, detail=str(e))[m
[31m-    except Exception as e:[m
[31m-        import traceback[m
[31m-        error_detail = f"ê°­ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[31m-        raise HTTPException(status_code=500, detail=error_detail)[m
[31m-[m
[31m-@router.get([m
[31m-    "/skill_search",[m
[31m-    summary="ìŠ¤í‚¬ëª… ê²€ìƒ‰",[m
[31m-    description="""[m
[31m-weekly_skill_stats í…Œì´ë¸”ì—ì„œ ìŠ¤í‚¬ëª…ì„ ê²€ìƒ‰í•˜ì—¬ í•´ë‹¹ ìŠ¤í‚¬ì˜ í†µê³„ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[31m-- ë¶€ë¶„ ê²€ìƒ‰ì„ ì§€ì›í•©ë‹ˆë‹¤ (ì˜ˆ: "aw" ê²€ìƒ‰ ì‹œ "aws" í¬í•¨ëœ ìŠ¤í‚¬ë“¤ì´ ê²€ìƒ‰ë¨)[m
[31m-- count, ì§ë¬´ëª…, field_type ì •ë³´ë¥¼ í•¨ê»˜ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[31m-[m
[31m-**ì‘ë‹µ ì˜ˆì‹œ:**[m
[31m-```json[m
[31m-[[m
[31m-  {[m
[31m-    "skill": "AWS",[m
[31m-    "count": 15,[m
[31m-    "job_name": "ë°±ì—”ë“œ ê°œë°œì",[m
[31m-    "field_type": "tech_stack",[m
[31m-    "week": 29,[m
[31m-    "date": "2025-01-15"[m
[31m-  }[m
[31m-][m
[31m-```[m
[31m-""",[m
[31m-    response_model=List[Dict[str, Any]][m
[31m-)[m
[31m-def skill_search([m
[31m-    skill_name: str = Query(..., description="ê²€ìƒ‰í•  ìŠ¤í‚¬ëª… (ë¶€ë¶„ ê²€ìƒ‰ ì§€ì›)"),[m
[31m-    db: Session = Depends(get_db)[m
[31m-):[m
[31m-    """[m
[31m-    weekly_skill_stats í…Œì´ë¸”ì—ì„œ ìŠ¤í‚¬ëª…ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.[m
[31m-    """[m
[31m-    try:[m
[31m-        # ìŠ¤í‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë¶€ë¶„ ê²€ìƒ‰, ë§Œë£Œë˜ì§€ ì•Šì€ ê³µê³  ê¸°ë°˜ í†µê³„ë§Œ)[m
[31m-        stats = db.query([m
[31m-            WeeklySkillStatModel.skill,[m
[31m-            WeeklySkillStatModel.count,[m
[31m-            WeeklySkillStatModel.field_type,[m
[31m-            WeeklySkillStatModel.week,[m
[31m-            WeeklySkillStatModel.date,[m
[31m-            JobRequiredSkill.job_name[m
[31m-        ).join([m
[31m-            JobRequiredSkill,[m
[31m-            WeeklySkillStatModel.job_role_id == JobRequiredSkill.id[m
[31m-        ).filter([m
[31m-            WeeklySkillStatModel.skill.ilike(f"%{skill_name}%")[m
[31m-        ).order_by([m
[31m-            WeeklySkillStatModel.count.desc(),[m
[31m-            WeeklySkillStatModel.skill.asc()[m
[31m-        ).all()[m
[31m-        [m
[31m-        # ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜[m
[31m-        result = [][m
[31m-        for stat in stats:[m
[31m-            result.append({[m
[31m-                "skill": stat.skill,[m
[31m-                "count": stat.count,[m
[31m-                "job_name": stat.job_name,[m
[31m-                "field_type": stat.field_type,[m
[31m-                "week": stat.week,[m
[31m-                "date": stat.date.isoformat() if stat.date else None[m
[31m-            })[m
[31m-        [m
[31m-        return result[m
[31m-        [m
[31m-    except Exception as e:[m
[31m-        import traceback[m
[31m-        error_detail = f"ìŠ¤í‚¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[31m-        raise HTTPException(status_code=500, detail=error_detail)[m
[31m-[m
[31m-@router.get([m
[31m-    "/roadmap_recommendations",[m
[31m-    summary="ë¡œë“œë§µ ì¶”ì²œ",[m
[31m-    description="""[m
[31m-ì‚¬ìš©ìì˜ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤í˜• ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[31m-[m
[31m-- ê°­ ë¶„ì„ì„ í†µí•´ ë¶€ì¡±í•œ ìŠ¤í‚¬ì„ íŒŒì•…[m
[31m-- íŠ¸ë Œë“œ ìŠ¤í‚¬ê³¼ ì‚¬ìš©ì ìŠ¤í‚¬ì„ ë¹„êµí•˜ì—¬ ì ìˆ˜ ê³„ì‚°[m
[31m-- ì ìˆ˜ê°€ ë†’ì€ ë¡œë“œë§µì„ ìš°ì„ ì ìœ¼ë¡œ ì¶”ì²œ[m
[31m-- limit íŒŒë¼ë¯¸í„°ë¡œ ê° íƒ€ì…ë³„ ì¶”ì²œ ê°œìˆ˜ ì¡°ì ˆ ê°€ëŠ¥ (ê¸°ë³¸ê°’: 10ê°œì”©, ì´ 20ê°œ)[m
[31m-- ë¶€íŠ¸ìº í”„ limitê°œ + ê°•ì˜ limitê°œë¥¼ ë°˜í™˜[m
[31m-- type íŒŒë¼ë¯¸í„°ë¡œ ë¶€íŠ¸ìº í”„/ê°•ì˜ í•„í„°ë§ ê°€ëŠ¥[m
[31m-""",[m
[31m-    response_model=List[Dict[str, Any]][m
[31m-)[m
[31m-async def get_roadmap_recommendations_endpoint([m
[31m-    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[31m-    limit: int = Query(10, description="ê° íƒ€ì…ë³„ ì¶”ì²œë°›ì„ ë¡œë“œë§µ ê°œìˆ˜ (ìµœëŒ€ 20ê°œì”©, ì´ 40ê°œ)"),[m
[31m-    type: Optional[str] = Query(None, description="í•„í„°ë§í•  íƒ€ì… (ì˜ˆ: ë¶€íŠ¸ìº í”„, ê°•ì˜)"),[m
[31m-    db: Session = Depends(get_db),[m
[31m-    current_user: User = Depends(get_current_user)[m
[31m-):[m
[31m-    """[m
[31m-    ì‚¬ìš©ìì—ê²Œ ë§ëŠ” ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[31m-    """[m
[31m-    try:[m
[31m-        # limit ê²€ì¦[m
[31m-        if limit > 20:[m
[31m-            limit = 20[m
[31m-        elif limit < 1:[m
[31m-            limit = 1[m
[31m-            [m
[31m-        user_id = getattr(current_user, "id", None)[m
[31m-        if user_id is None:[m
[31m-            raise HTTPException(status_code=400, detail="ì‚¬ìš©ì IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[31m-        [m
[31m-        # 1. ê°­ ë¶„ì„ ìˆ˜í–‰[m
[31m-        gap_analysis_result = perform_gap_analysis_visualization(user_id, category, db)[m
[31m-        [m
[31m-        # 2. ë¡œë“œë§µ ì¶”ì²œ ìˆ˜í–‰[m
[31m-        recommended_roadmaps = get_roadmap_recommendations([m
[31m-            user_id=user_id,[m
[31m-            category=category,[m
[31m-            gap_result_text=gap_analysis_result["gap_result"],[m
[31m-            db=db,[m
[31m-            limit=limit[m
[31m-        )[m
[31m-        [m
[31m-        # 3. typeë³„ í•„í„°ë§[m
[31m-        if type:[m
[31m-            filtered_roadmaps = [roadmap for roadmap in recommended_roadmaps if roadmap.get('type') == type][m
[31m-            return filtered_roadmaps[m
[31m-        [m
[31m-        return recommended_roadmaps[m
[31m-        [m
[31m-    except ValueError as e:[m
[31m-        raise HTTPException(status_code=404, detail=str(e))[m
[31m-    except Exception as e:[m
[31m-        import traceback[m
[31m-        error_detail = f"ë¡œë“œë§µ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[31m-        raise HTTPException(status_code=500, detail=error_detail)[m
[31m-[m
[31m-@router.get([m
[31m-    "/roadmap_recommendations/direct",[m
[31m-    summary="ì§ì ‘ ê°­ ë¶„ì„ ê²°ê³¼ë¡œ ë¡œë“œë§µ ì¶”ì²œ",[m
[31m-    description="""[m
[31m-ì´ë¯¸ ìˆ˜í–‰ëœ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ì§ì ‘ ì…ë ¥ë°›ì•„ ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[31m-[m
[31m-- ê°­ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥[m
[31m-- ë³„ë„ì˜ ê°­ ë¶„ì„ ê³¼ì • ì—†ì´ ë°”ë¡œ ë¡œë“œë§µ ì¶”ì²œ[m
[31m-- ê¸°ì¡´ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ì¬í™œìš©í•  ë•Œ ìœ ìš©[m
[31m-- limit íŒŒë¼ë¯¸í„°ë¡œ ê° íƒ€ì…ë³„ ì¶”ì²œ ê°œìˆ˜ ì¡°ì ˆ ê°€ëŠ¥ (ê¸°ë³¸ê°’: 10ê°œì”©, ì´ 20ê°œ)[m
[31m-- ë¶€íŠ¸ìº í”„ limitê°œ + ê°•ì˜ limitê°œë¥¼ ë°˜í™˜[m
[31m-- type íŒŒë¼ë¯¸í„°ë¡œ ë¶€íŠ¸ìº í”„/ê°•ì˜ í•„í„°ë§ ê°€ëŠ¥[m
[31m-""",[m
[31m-    response_model=List[Dict[str, Any]][m
[31m-)[m
[31m-async def get_roadmap_recommendations_direct([m
[31m-    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[31m-    gap_result_text: str = Query(..., description="ê°­ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸"),[m
[31m-    limit: int = Query(10, description="ê° íƒ€ì…ë³„ ì¶”ì²œë°›ì„ ë¡œë“œë§µ ê°œìˆ˜ (ìµœëŒ€ 20ê°œì”©, ì´ 40ê°œ)"),[m
[31m-    type: Optional[str] = Query(None, description="í•„í„°ë§í•  íƒ€ì… (ì˜ˆ: ë¶€íŠ¸ìº í”„, ê°•ì˜)"),[m
[31m-    db: Session = Depends(get_db),[m
[31m-    current_user: User = Depends(get_current_user)[m
[31m-):[m
[31m-    """[m
[31m-    ì§ì ‘ ì…ë ¥ëœ ê°­ ë¶„ì„ ê²°ê³¼ë¡œ ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[31m-    """[m
[31m-    try:[m
[31m-        # limit ê²€ì¦[m
[31m-        if limit > 20:[m
[31m-            limit = 20[m
[31m-        elif limit < 1:[m
[31m-            limit = 1[m
[31m-            [m
[31m-        user_id = getattr(current_user, "id", None)[m
[31m-        if user_id is None:[m
[31m-            raise HTTPException(status_code=400, detail="ì‚¬ìš©ì IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[31m-        [m
[31m-        # ë¡œë“œë§µ ì¶”ì²œ ìˆ˜í–‰[m
[31m-        recommended_roadmaps = get_roadmap_recommendations([m
[31m-            user_id=user_id,[m
[31m-            category=category,[m
[31m-            gap_result_text=gap_result_text,[m
[31m-            db=db,[m
[31m-            limit=limit[m
[31m-        )[m
[31m-        [m
[31m-        # typeë³„ í•„í„°ë§[m
[31m-        if type:[m
[31m-            filtered_roadmaps = [roadmap for roadmap in recommended_roadmaps if roadmap.get('type') == type][m
[31m-            return filtered_roadmaps[m
[31m-        [m
[31m-        return recommended_roadmaps[m
[31m-        [m
[31m-    except Exception as e:[m
[31m-        import traceback[m
[31m-        error_detail = f"ë¡œë“œë§µ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[31m-        raise HTTPException(status_code=500, detail=error_detail)[m
[32m+[m[32mfrom fastapi import APIRouter, Depends, Query, HTTPException[m
[32m+[m[32mfrom sqlalchemy.orm import Session[m
[32m+[m[32mfrom sqlalchemy import func, and_, or_[m
[32m+[m[32mfrom typing import List, Dict, Any, Optional[m
[32m+[m[32mfrom starlette.responses import JSONResponse[m
[32m+[m[32mfrom app.database import get_db[m
[32m+[m[32mfrom app.models.job_post import JobPost[m
[32m+[m[32mfrom app.models.job_required_skill import JobRequiredSkill[m
[32m+[m[32mfrom app.schemas.visualization import WeeklySkillStat, ResumeSkillComparison[m
[32m+[m[32mfrom app.utils.dependencies import get_current_user[m
[32m+[m[32mfrom app.models.user_skill import UserSkill[m
[32m+[m[32mfrom app.models.user import User[m
[32m+[m[32mfrom app.models.certificate import Certificate[m
[32m+[m[32mfrom app.services.gap_model import perform_gap_analysis_visualization[m
[32m+[m[32mfrom app.services.weekly_stats_service import WeeklyStatsService[m
[32m+[m[32mfrom app.models.weekly_skill_stat import WeeklySkillStat as WeeklySkillStatModel[m
[32m+[m[32mfrom app.services.roadmap_model import get_roadmap_recommendations[m
[32m+[m
[32m+[m[32mrouter = APIRouter(prefix="/visualization", tags=["Visualization"])[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/weekly_skill_frequency",[m
[32m+[m[32m    operation_id="weekly_skill_frequency",[m
[32m+[m[32m    summary="ì§ë¬´ë³„ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ ì¡°íšŒ (ì£¼ì°¨ ë²”ìœ„ ì§€ì •)",[m
[32m+[m[32m    description="""[m
[32m+[m[32mì„ íƒí•œ **ì§ë¬´ëª…(`job_name`)**ê³¼ ë¶„ì„ í•„ë“œ(`field`)ì— ëŒ€í•´, ì§€ì •ëœ ì£¼ì°¨ ë²”ìœ„ì˜ ì±„ìš©ê³µê³ ì—ì„œ ì¶”ì¶œëœ **ê¸°ìˆ /í‚¤ì›Œë“œì˜ ì£¼ë³„ ë“±ì¥ ë¹ˆë„**ë¥¼ ì§‘ê³„í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m- **ì§ë¬´ëª…**ì€ ë“±ë¡ëœ ì§ë¬´ í…Œì´ë¸”(`JobRequiredSkill`)ì˜ `job_name` ê°’ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.[m
[32m+[m[32m- ì…ë ¥ëœ `job_name`ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° 404 ì—ëŸ¬ê°€ ë°˜í™˜ë©ë‹ˆë‹¤.[m
[32m+[m[32m- ë¶„ì„ ëŒ€ìƒ í•„ë“œ(`field`)ëŠ” ì•„ë˜ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•˜ë©°, í•´ë‹¹ í•„ë“œëŠ” ì±„ìš©ê³µê³ (`JobPost`) ëª¨ë¸ì— ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.[m
[32m+[m[32m    - tech_stack, qualifications, preferences, required_skills, preferred_skills[m
[32m+[m[32m- `weeks_back` íŒŒë¼ë¯¸í„°ë¡œ ì¡°íšŒí•  ì£¼ì°¨ ë²”ìœ„ë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.[m
[32m+[m[32m- ë°˜í™˜ ë°ì´í„°ëŠ” [ì—°ë„, ì£¼ì°¨, ìŠ¤í‚¬, ë¹ˆë„] í˜•íƒœì˜ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.[m
[32m+[m[32m- ì›Œë“œí´ë¼ìš°ë“œ, íŠ¸ë Œë“œ ì°¨íŠ¸, í†µê³„ ë“±ì— í™œìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m**ì‘ë‹µ ì˜ˆì‹œ:**[m
[32m+[m[32m```json[m
[32m+[m[32m[[m
[32m+[m[32m  { "year": 2025, "week": 28, "skill": "Python", "count": 12 },[m
[32m+[m[32m  { "year": 2025, "week": 28, "skill": "SQL", "count": 7 },[m
[32m+[m[32m  { "year": 2025, "week": 27, "skill": "Java", "count": 5 }[m
[32m+[m[32m][m
[32m+[m[32m""",[m
[32m+[m[32m    response_model=List[WeeklySkillStat][m
[32m+[m[32m)[m
[32m+[m[32mdef weekly_skill_frequency([m
[32m+[m[32m    job_name: str = Query(..., description="ì¡°íšŒí•  ì§ë¬´ëª… (ì˜ˆ: ë°±ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    field: str = Query([m
[32m+[m[32m        "tech_stack",[m
[32m+[m[32m        enum=[[m
[32m+[m[32m            "tech_stack", "qualifications", "preferences",[m
[32m+[m[32m            "required_skills", "preferred_skills"[m
[32m+[m[32m        ],[m
[32m+[m[32m        description="ë¶„ì„ ëŒ€ìƒ í•„ë“œëª… (ì±„ìš©ê³µê³  ëª¨ë¸ì— ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ ì¤‘ ì„ íƒ)"[m
[32m+[m[32m    ),[m
[32m+[m[32m    weeks_back: int = Query(0, ge=0, le=52, description="ëª‡ ì£¼ ì „ê¹Œì§€ ì¡°íšŒí• ì§€ (0: í˜„ì¬ ì£¼ì°¨ë§Œ, 1: í˜„ì¬+ì´ì „ 1ì£¼ì°¨, ìµœëŒ€ 52ì£¼)"),[m
[32m+[m[32m    db: Session = Depends(get_db)[m
[32m+[m[32m):[m
[32m+[m[32m    # 1. ì§ë¬´ëª… â†’ id ë§¤í•‘[m
[32m+[m[32m    job_role = db.query(JobRequiredSkill).filter(JobRequiredSkill.job_name == job_name).first()[m
[32m+[m[32m    if not job_role:[m
[32m+[m[32m        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì§ë¬´ëª…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")[m
[32m+[m[32m    job_role_id = job_role.id[m
[32m+[m
[32m+[m[32m    # 2. í˜„ì¬ ì£¼ì°¨ ê³„ì‚°[m
[32m+[m[32m    from datetime import datetime[m
[32m+[m[32m    import pytz[m
[32m+[m[41m    [m
[32m+[m[32m    seoul_tz = pytz.timezone('Asia/Seoul')[m
[32m+[m[32m    current_date = datetime.now(seoul_tz)[m
[32m+[m[32m    current_week = current_date.isocalendar()[1]  # í˜„ì¬ ISO ì£¼ì°¨[m
[32m+[m[41m    [m
[32m+[m[32m    # 3. í•´ë‹¹ ì§ë¬´idë¡œ JobPost í•„í„°ë§ & í˜„ì¬ ì£¼ì°¨ë§Œ ì§‘ê³„ (ë§Œë£Œë˜ì§€ ì•Šì€ ê³µê³ ë§Œ)[m
[32m+[m[32m    posts = db.query([m
[32m+[m[32m        JobPost.posting_date,[m
[32m+[m[32m        getattr(JobPost, field)[m
[32m+[m[32m    ).filter([m
[32m+[m[32m        and_([m
[32m+[m[32m            JobPost.job_required_skill_id == job_role_id,[m
[32m+[m[32m            or_(JobPost.is_expired.is_(None), JobPost.is_expired.is_(False))[m
[32m+[m[32m        )[m
[32m+[m[32m    ).all()[m
[32m+[m
[32m+[m[32m    # 4. í˜„ì¬ ì£¼ì°¨ì˜ ê¸°ìˆ  í‚¤ì›Œë“œ ì¹´ìš´íŠ¸[m
[32m+[m[32m    from collections import Counter[m
[32m+[m[32m    skill_counter = Counter()[m
[32m+[m[32m    for row in posts:[m
[32m+[m[32m        posting_date, field_value = row.posting_date, row[1][m
[32m+[m[41m        [m
[32m+[m[32m        # í˜„ì¬ ì£¼ì°¨ì˜ ê³µê³ ë§Œ ì²˜ë¦¬[m
[32m+[m[32m        post_week = posting_date.isocalendar()[1][m
[32m+[m[32m        if post_week == current_week:[m
[32m+[m[32m                        # í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬[m
[32m+[m[32m            if field == "tech_stack":[m
[32m+[m[32m                # tech_stackì€ ë¬¸ìì—´ í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[32m            else:[m
[32m+[m[32m                # required_skills, preferred_skills, main_tasks_skillsëŠ” JSONB í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, list):[m
[32m+[m[32m                    skills = [str(skill).strip() for skill in field_value if skill][m
[32m+[m[32m                elif isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    # JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„[m
[32m+[m[32m                    try:[m
[32m+[m[32m                        import json[m
[32m+[m[32m                        parsed = json.loads(field_value)[m
[32m+[m[32m                        if isinstance(parsed, list):[m
[32m+[m[32m                            skills = [str(skill).strip() for skill in parsed if skill][m
[32m+[m[32m                    except:[m
[32m+[m[32m                        # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬[m
[32m+[m[32m                        skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[41m            [m
[32m+[m[32m            if skills:[m
[32m+[m[32m                skill_counter.update(skills)[m
[32m+[m
[32m+[m[32m    # 5. ê²°ê³¼ ì‘ë‹µ (í˜„ì¬ ì£¼ì°¨ë§Œ)[m
[32m+[m[32m    response = [][m
[32m+[m[32m    for skill, count in skill_counter.items():[m
[32m+[m[32m        response.append(WeeklySkillStat([m
[32m+[m[32m            week=current_week,[m[41m [m
[32m+[m[32m            date=current_date.date(),[m[41m [m
[32m+[m[32m            skill=skill,[m[41m [m
[32m+[m[32m            count=count[m
[32m+[m[32m        ))[m
[32m+[m[32m    # count ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬[m
[32m+[m[32m    response = sorted(response, key=lambda x: x.count, reverse=True)[m
[32m+[m[32m    return response[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/weekly_skill_frequency_current",[m
[32m+[m[32m    operation_id="weekly_skill_frequency_current",[m
[32m+[m[32m    summary="ì§ë¬´ë³„ í˜„ì¬ ì£¼ì°¨ ìŠ¤í‚¬ ë¹ˆë„ ì¡°íšŒ",[m
[32m+[m[32m    description="""[m
[32m+[m[32mì„ íƒí•œ **ì§ë¬´ëª…(`job_name`)**ê³¼ ë¶„ì„ í•„ë“œ(`field`)ì— ëŒ€í•´, **í˜„ì¬ ì£¼ì°¨ì˜ ì±„ìš©ê³µê³ **ì—ì„œ ì¶”ì¶œëœ **ê¸°ìˆ /í‚¤ì›Œë“œì˜ ë“±ì¥ ë¹ˆë„**ë¥¼ ì§‘ê³„í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m- **ì§ë¬´ëª…**ì€ ë“±ë¡ëœ ì§ë¬´ í…Œì´ë¸”(`JobRequiredSkill`)ì˜ `job_name` ê°’ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.[m
[32m+[m[32m- ì…ë ¥ëœ `job_name`ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° 404 ì—ëŸ¬ê°€ ë°˜í™˜ë©ë‹ˆë‹¤.[m
[32m+[m[32m- ë¶„ì„ ëŒ€ìƒ í•„ë“œ(`field`)ëŠ” ì•„ë˜ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•˜ë©°, í•´ë‹¹ í•„ë“œëŠ” ì±„ìš©ê³µê³ (`JobPost`) ëª¨ë¸ì— ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.[m
[32m+[m[32m    - tech_stack, qualifications, preferences, required_skills, preferred_skills[m
[32m+[m[32m- **í˜„ì¬ ì£¼ì°¨ë§Œ** ì¡°íšŒí•˜ì—¬ ì‹¤ì‹œê°„ íŠ¸ë Œë“œë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.[m
[32m+[m[32m- ë°˜í™˜ ë°ì´í„°ëŠ” [ì—°ë„, ì£¼ì°¨, ìŠ¤í‚¬, ë¹ˆë„] í˜•íƒœì˜ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m**ì‘ë‹µ ì˜ˆì‹œ:**[m
[32m+[m[32m```json[m
[32m+[m[32m[[m
[32m+[m[32m  { "year": 2025, "week": 29, "skill": "Python", "count": 12 },[m
[32m+[m[32m  { "year": 2025, "week": 29, "skill": "SQL", "count": 7 },[m
[32m+[m[32m  { "year": 2025, "week": 29, "skill": "Java", "count": 5 }[m
[32m+[m[32m][m
[32m+[m[32m""",[m
[32m+[m[32m    response_model=List[WeeklySkillStat][m
[32m+[m[32m)[m
[32m+[m[32mdef weekly_skill_frequency_current([m
[32m+[m[32m    job_name: str = Query(..., description="ì¡°íšŒí•  ì§ë¬´ëª… (ì˜ˆ: ë°±ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    field: str = Query([m
[32m+[m[32m        "tech_stack",[m
[32m+[m[32m        enum=[[m
[32m+[m[32m            "tech_stack", "qualifications", "preferences",[m
[32m+[m[32m            "required_skills", "preferred_skills"[m
[32m+[m[32m        ],[m
[32m+[m[32m        description="ë¶„ì„ ëŒ€ìƒ í•„ë“œëª… (ì±„ìš©ê³µê³  ëª¨ë¸ì— ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ ì¤‘ ì„ íƒ)"[m
[32m+[m[32m    ),[m
[32m+[m[32m    db: Session = Depends(get_db)[m
[32m+[m[32m):[m
[32m+[m[32m    # 1. ì§ë¬´ëª… â†’ id ë§¤í•‘[m
[32m+[m[32m    job_role = db.query(JobRequiredSkill).filter(JobRequiredSkill.job_name == job_name).first()[m
[32m+[m[32m    if not job_role:[m
[32m+[m[32m        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì§ë¬´ëª…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")[m
[32m+[m[32m    job_role_id = job_role.id[m
[32m+[m
[32m+[m[32m    # 2. í˜„ì¬ ì£¼ì°¨ ê³„ì‚°[m
[32m+[m[32m    from datetime import datetime[m
[32m+[m[32m    import pytz[m
[32m+[m[41m    [m
[32m+[m[32m    seoul_tz = pytz.timezone('Asia/Seoul')[m
[32m+[m[32m    current_date = datetime.now(seoul_tz)[m
[32m+[m[32m    current_week = current_date.isocalendar()[1]  # í˜„ì¬ ISO ì£¼ì°¨[m
[32m+[m[41m    [m
[32m+[m[32m    # 3. í•´ë‹¹ ì§ë¬´idë¡œ JobPost í•„í„°ë§ & í˜„ì¬ ì£¼ì°¨ë§Œ ì§‘ê³„ (ë§Œë£Œë˜ì§€ ì•Šì€ ê³µê³ ë§Œ)[m
[32m+[m[32m    posts = db.query([m
[32m+[m[32m        JobPost.posting_date,[m
[32m+[m[32m        getattr(JobPost, field)[m
[32m+[m[32m    ).filter([m
[32m+[m[32m        and_([m
[32m+[m[32m            JobPost.job_required_skill_id == job_role_id,[m
[32m+[m[32m            or_(JobPost.is_expired.is_(None), JobPost.is_expired.is_(False))[m
[32m+[m[32m        )[m
[32m+[m[32m    ).all()[m
[32m+[m
[32m+[m[32m    # 4. í˜„ì¬ ì£¼ì°¨ì˜ ê¸°ìˆ  í‚¤ì›Œë“œ ì¹´ìš´íŠ¸[m
[32m+[m[32m    from collections import Counter[m
[32m+[m[32m    skill_counter = Counter()[m
[32m+[m[32m    for row in posts:[m
[32m+[m[32m        posting_date, field_value = row.posting_date, row[1][m
[32m+[m[41m        [m
[32m+[m[32m        # í˜„ì¬ ì£¼ì°¨ì˜ ê³µê³ ë§Œ ì²˜ë¦¬[m
[32m+[m[32m        post_week = posting_date.isocalendar()[1][m
[32m+[m[32m        if post_week == current_week:[m
[32m+[m[32m            skills = [][m
[32m+[m[41m            [m
[32m+[m[32m            # í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬[m
[32m+[m[32m            if field == "tech_stack":[m
[32m+[m[32m                # tech_stackì€ ë¬¸ìì—´ í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[32m            else:[m
[32m+[m[32m                # required_skills, preferred_skills, main_tasks_skillsëŠ” JSONB í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, list):[m
[32m+[m[32m                    skills = [str(skill).strip() for skill in field_value if skill][m
[32m+[m[32m                elif isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    # JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„[m
[32m+[m[32m                    try:[m
[32m+[m[32m                        import json[m
[32m+[m[32m                        parsed = json.loads(field_value)[m
[32m+[m[32m                        if isinstance(parsed, list):[m
[32m+[m[32m                            skills = [str(skill).strip() for skill in parsed if skill][m
[32m+[m[32m                    except:[m
[32m+[m[32m                        # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬[m
[32m+[m[32m                        skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[41m            [m
[32m+[m[32m            if skills:[m
[32m+[m[32m                skill_counter.update(skills)[m
[32m+[m
[32m+[m[32m    # 5. ê²°ê³¼ ì‘ë‹µ (í˜„ì¬ ì£¼ì°¨ë§Œ)[m
[32m+[m[32m    response = [][m
[32m+[m[32m    for skill, count in skill_counter.items():[m
[32m+[m[32m        response.append(WeeklySkillStat([m
[32m+[m[32m            week=current_week,[m[41m [m
[32m+[m[32m            date=current_date.date(),[m[41m [m
[32m+[m[32m            skill=skill,[m[41m [m
[32m+[m[32m            count=count[m
[32m+[m[32m        ))[m
[32m+[m[32m    # count ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬[m
[32m+[m[32m    response = sorted(response, key=lambda x: x.count, reverse=True)[m
[32m+[m[32m    return response[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/resume_vs_job_skill_trend",[m
[32m+[m[32m    summary="ë‚´ ì´ë ¥ì„œ vs ì§ë¬´ë³„ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ ë¹„êµ",[m
[32m+[m[32m    description="ë‚´ ì´ë ¥ì„œ(ë³´ìœ  ìŠ¤í‚¬)ì™€ ì„ íƒí•œ ì§ë¬´ì˜ ì£¼ê°„ ìŠ¤í‚¬ ë¹ˆë„ í†µê³„ë¥¼ ë¹„êµí•˜ì—¬ ê°•ì (ë³´ìœ )/ì•½ì (ë¯¸ë³´ìœ ) ìŠ¤í‚¬ì„ ì‹œê°í™”í•  ìˆ˜ ìˆë„ë¡ ë°˜í™˜í•©ë‹ˆë‹¤.",[m
[32m+[m[32m    response_model=List[ResumeSkillComparison][m
[32m+[m[32m)[m
[32m+[m[32masync def resume_vs_job_skill_trend([m
[32m+[m[32m    job_name: str = Query(..., description="ë¹„êµí•  ì§ë¬´ëª… (ì˜ˆ: ë°±ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    field: str = Query([m
[32m+[m[32m        "tech_stack",[m
[32m+[m[32m        enum=[[m
[32m+[m[32m            "tech_stack", "qualifications", "preferences",[m
[32m+[m[32m            "required_skills", "preferred_skills"[m
[32m+[m[32m        ],[m
[32m+[m[32m        description="ë¶„ì„ ëŒ€ìƒ í•„ë“œëª… (ì±„ìš©ê³µê³  ëª¨ë¸ì— ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ ì¤‘ ì„ íƒ)"[m
[32m+[m[32m    ),[m
[32m+[m[32m    db: Session = Depends(get_db),[m
[32m+[m[32m    current_user: User = Depends(get_current_user)[m
[32m+[m[32m):[m
[32m+[m[32m    # 1. ë‚´ ì´ë ¥ì„œ(ë³´ìœ  ìŠ¤í‚¬) ì¡°íšŒ[m
[32m+[m[32m    user_skills = db.query(UserSkill).filter(UserSkill.user_id == current_user.id).all()[m
[32m+[m[32m    my_skill_set = set()[m
[32m+[m[32m    for us in user_skills:[m
[32m+[m[32m        if hasattr(us, 'skill') and us.skill and hasattr(us.skill, 'name'):[m
[32m+[m[32m            my_skill_set.add(us.skill.name)[m
[32m+[m[32m        elif hasattr(us, 'skill_name'):[m
[32m+[m[32m            my_skill_set.add(us.skill_name)[m
[32m+[m
[32m+[m[32m    # 2. í˜„ì¬ ì£¼ì°¨ ê³„ì‚°[m
[32m+[m[32m    seoul_tz = pytz.timezone('Asia/Seoul')[m
[32m+[m[32m    current_date = datetime.now(seoul_tz)[m
[32m+[m[32m    current_week = current_date.isocalendar()[1]  # í˜„ì¬ ISO ì£¼ì°¨[m
[32m+[m[41m    [m
[32m+[m[32m    # 3. ì§ë¬´ë³„ í˜„ì¬ ì£¼ì°¨ ìŠ¤í‚¬ ë¹ˆë„ ë°ì´í„° ì¡°íšŒ[m
[32m+[m[32m    job_role = db.query(JobRequiredSkill).filter(JobRequiredSkill.job_name == job_name).first()[m
[32m+[m[32m    if not job_role:[m
[32m+[m[32m        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì§ë¬´ëª…ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")[m
[32m+[m[32m    job_role_id = job_role.id[m
[32m+[m[32m    posts = db.query([m
[32m+[m[32m        JobPost.posting_date,[m
[32m+[m[32m        getattr(JobPost, field)[m
[32m+[m[32m    ).filter([m
[32m+[m[32m        and_([m
[32m+[m[32m            JobPost.job_required_skill_id == job_role_id,[m
[32m+[m[32m            or_(JobPost.is_expired.is_(None), JobPost.is_expired.is_(False))[m
[32m+[m[32m        )[m
[32m+[m[32m    ).all()[m
[32m+[m[41m    [m
[32m+[m[32m    from collections import Counter[m
[32m+[m[32m    skill_counter = Counter()[m
[32m+[m[32m    for row in posts:[m
[32m+[m[32m        posting_date, field_value = row.posting_date, row[1][m
[32m+[m[41m        [m
[32m+[m[32m        # í˜„ì¬ ì£¼ì°¨ì˜ ê³µê³ ë§Œ ì²˜ë¦¬[m
[32m+[m[32m        post_week = posting_date.isocalendar()[1][m
[32m+[m[32m        if post_week == current_week:[m
[32m+[m[32m                        # í•„ë“œ íƒ€ì…ì— ë”°ë¥¸ ì²˜ë¦¬[m
[32m+[m[32m            if field == "tech_stack":[m
[32m+[m[32m                # tech_stackì€ ë¬¸ìì—´ í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[32m            else:[m
[32m+[m[32m                # required_skills, preferred_skills, main_tasks_skillsëŠ” JSONB í•„ë“œ[m
[32m+[m[32m                if isinstance(field_value, list):[m
[32m+[m[32m                    skills = [str(skill).strip() for skill in field_value if skill][m
[32m+[m[32m                elif isinstance(field_value, str) and field_value.strip():[m
[32m+[m[32m                    # JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹± ì‹œë„[m
[32m+[m[32m                    try:[m
[32m+[m[32m                        import json[m
[32m+[m[32m                        parsed = json.loads(field_value)[m
[32m+[m[32m                        if isinstance(parsed, list):[m
[32m+[m[32m                            skills = [str(skill).strip() for skill in parsed if skill][m
[32m+[m[32m                    except:[m
[32m+[m[32m                        # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬[m
[32m+[m[32m                        skills = [s.strip() for s in field_value.replace(';', ',').replace('/', ',').split(',') if s.strip()][m
[32m+[m[41m            [m
[32m+[m[32m            # ìŠ¤í‚¬ëª… ê¸¸ì´ ì œí•œ (500ì)[m
[32m+[m[32m            if skills:[m
[32m+[m[32m                limited_skills = [][m
[32m+[m[32m                for skill in skills:[m
[32m+[m[32m                    if len(skill) > 500:[m
[32m+[m[32m                        skill = skill[:497] + "..."  # 500ìë¡œ ì œí•œ[m
[32m+[m[32m                    limited_skills.append(skill)[m
[32m+[m[32m                skill_counter.update(limited_skills)[m
[32m+[m[32m    # 4. ê°•ì /ì•½ì  ë¹„êµ ë° ì‘ë‹µ ìƒì„± (í˜„ì¬ ì£¼ì°¨ë§Œ)[m
[32m+[m[32m    response = [][m
[32m+[m[32m    for skill, count in skill_counter.items():[m
[32m+[m[32m        status = "ê°•ì " if skill in my_skill_set else "ì•½ì "[m
[32m+[m[32m        response.append(ResumeSkillComparison([m
[32m+[m[32m            skill=skill, count=count, status=status, week=current_week, date=current_date.date()[m
[32m+[m[32m        ))[m
[32m+[m[32m    return response[m
[32m+[m
[32m+[m[32m@router.get("/gap-analysis", response_class=JSONResponse,[m
[32m+[m[32m    summary="GPT ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„",[m
[32m+[m[32m    description="""[m
[32m+[m[32mì‚¬ìš©ìì˜ ì´ë ¥ ì •ë³´ì™€ ì„ íƒí•œ ì§ë¬´(ì¹´í…Œê³ ë¦¬)ë¥¼ ë°”íƒ•ìœ¼ë¡œ GPT(OpenRouter) ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.\n[m
[32m+[m[32m- ë¶„ì„ ê²°ê³¼ëŠ” ìì—°ì–´ ì„¤ëª…(gap_result)ê³¼ ë¶€ì¡± ì—­ëŸ‰ Top 5 ë¦¬ìŠ¤íŠ¸(top_skills)ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.\n[m
[32m+[m[32m- í”„ë¡ íŠ¸ì—”ë“œëŠ” gap_resultë¥¼ ì¶œë ¥ìš©ìœ¼ë¡œ, top_skillsë¥¼ íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë“± ë‚´ë¶€ í™œìš©ì— ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n[m
[32m+[m[32m- LLM í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë°˜í™˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.[m
[32m+[m[32m"""[m
[32m+[m[32m)[m
[32m+[m[32mdef gap_analysis_endpoint([m
[32m+[m[32m    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    db: Session = Depends(get_db),[m
[32m+[m[32m    current_user: User = Depends(get_current_user)[m
[32m+[m[32m):[m
[32m+[m[32m    """[m
[32m+[m[32m    ì‚¬ìš©ìì˜ ì´ë ¥ ì •ë³´ì™€ ì„ íƒí•œ ì§ë¬´ë¥¼ ë°”íƒ•ìœ¼ë¡œ LLM ê¸°ë°˜ ê°­ì°¨ì´ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.[m
[32m+[m[32m    ë¶„ì„ ê²°ê³¼ëŠ” ìì—°ì–´ ì„¤ëª…ê³¼ ë¶€ì¡± ì—­ëŸ‰ Top 5 ë¦¬ìŠ¤íŠ¸ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.[m
[32m+[m[32m    """[m
[32m+[m[32m    try:[m
[32m+[m[32m        user_id = getattr(current_user, "id", None)[m
[32m+[m[32m        if user_id is None:[m
[32m+[m[32m            raise HTTPException(status_code=400, detail="ìœ ì € IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[32m+[m[32m        if hasattr(user_id, "__int__"):[m
[32m+[m[32m            user_id = int(user_id)[m
[32m+[m[32m        if not isinstance(user_id, int):[m
[32m+[m[32m            raise HTTPException(status_code=400, detail="ìœ ì € IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[32m+[m[32m        result = perform_gap_analysis_visualization(user_id, category, db=db)[m
[32m+[m
[32m+[m[32m        # 1. í”„ë¡ íŠ¸ì— ë³´ì—¬ì¤„ ìì—°ì–´ ê²°ê³¼[m
[32m+[m[32m        gap_result = result["gap_result"][m
[32m+[m
[32m+[m[32m        # 2. ë‚´ë¶€ To-Do ì‹œìŠ¤í…œìœ¼ë¡œ ë³´ë‚¼ Top 5 ìŠ¤í‚¬[m
[32m+[m[32m        top_skills = result["top_skills"][m
[32m+[m[32m        # ì˜ˆì‹œ: ì¶”í›„ ë¹„ë™ê¸°ë¡œ ë³´ë‚´ê±°ë‚˜ DBì— ì €ì¥[m
[32m+[m[32m        # send_to_todo(user_id, top_skills)[m
[32m+[m
[32m+[m[32m        return {[m
[32m+[m[32m            "gap_result": gap_result,      # í”„ë¡ íŠ¸ì— ì¶œë ¥í•  ìì—°ì–´[m
[32m+[m[32m            "top_skills": top_skills       # í”„ë¡ íŠ¸ê°€ íˆ¬ë‘ ë¦¬ìŠ¤íŠ¸ë¡œ í™œìš© ê°€ëŠ¥[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m    except ValueError as e:[m
[32m+[m[32m        raise HTTPException(status_code=404, detail=str(e))[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        import traceback[m
[32m+[m[32m        error_detail = f"ê°­ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[32m+[m[32m        raise HTTPException(status_code=500, detail=error_detail)[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/skill_search",[m
[32m+[m[32m    summary="ìŠ¤í‚¬ëª… ê²€ìƒ‰",[m
[32m+[m[32m    description="""[m
[32m+[m[32mweekly_skill_stats í…Œì´ë¸”ì—ì„œ ìŠ¤í‚¬ëª…ì„ ê²€ìƒ‰í•˜ì—¬ í•´ë‹¹ ìŠ¤í‚¬ì˜ í†µê³„ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[32m+[m[32m- ë¶€ë¶„ ê²€ìƒ‰ì„ ì§€ì›í•©ë‹ˆë‹¤ (ì˜ˆ: "aw" ê²€ìƒ‰ ì‹œ "aws" í¬í•¨ëœ ìŠ¤í‚¬ë“¤ì´ ê²€ìƒ‰ë¨)[m
[32m+[m[32m- count, ì§ë¬´ëª…, field_type ì •ë³´ë¥¼ í•¨ê»˜ ë°˜í™˜í•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m**ì‘ë‹µ ì˜ˆì‹œ:**[m
[32m+[m[32m```json[m
[32m+[m[32m[[m
[32m+[m[32m  {[m
[32m+[m[32m    "skill": "AWS",[m
[32m+[m[32m    "count": 15,[m
[32m+[m[32m    "job_name": "ë°±ì—”ë“œ ê°œë°œì",[m
[32m+[m[32m    "field_type": "tech_stack",[m
[32m+[m[32m    "week": 29,[m
[32m+[m[32m    "date": "2025-01-15"[m
[32m+[m[32m  }[m
[32m+[m[32m][m
[32m+[m[32m```[m
[32m+[m[32m""",[m
[32m+[m[32m    response_model=List[Dict[str, Any]][m
[32m+[m[32m)[m
[32m+[m[32mdef skill_search([m
[32m+[m[32m    skill_name: str = Query(..., description="ê²€ìƒ‰í•  ìŠ¤í‚¬ëª… (ë¶€ë¶„ ê²€ìƒ‰ ì§€ì›)"),[m
[32m+[m[32m    db: Session = Depends(get_db)[m
[32m+[m[32m):[m
[32m+[m[32m    """[m
[32m+[m[32m    weekly_skill_stats í…Œì´ë¸”ì—ì„œ ìŠ¤í‚¬ëª…ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.[m
[32m+[m[32m    """[m
[32m+[m[32m    try:[m
[32m+[m[32m        # ìŠ¤í‚¬ëª…ìœ¼ë¡œ ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë¶€ë¶„ ê²€ìƒ‰, ë§Œë£Œë˜ì§€ ì•Šì€ ê³µê³  ê¸°ë°˜ í†µê³„ë§Œ)[m
[32m+[m[32m        stats = db.query([m
[32m+[m[32m            WeeklySkillStatModel.skill,[m
[32m+[m[32m            WeeklySkillStatModel.count,[m
[32m+[m[32m            WeeklySkillStatModel.field_type,[m
[32m+[m[32m            WeeklySkillStatModel.week,[m
[32m+[m[32m            WeeklySkillStatModel.date,[m
[32m+[m[32m            JobRequiredSkill.job_name[m
[32m+[m[32m        ).join([m
[32m+[m[32m            JobRequiredSkill,[m
[32m+[m[32m            WeeklySkillStatModel.job_role_id == JobRequiredSkill.id[m
[32m+[m[32m        ).filter([m
[32m+[m[32m            WeeklySkillStatModel.skill.ilike(f"%{skill_name}%")[m
[32m+[m[32m        ).order_by([m
[32m+[m[32m            WeeklySkillStatModel.count.desc(),[m
[32m+[m[32m            WeeklySkillStatModel.skill.asc()[m
[32m+[m[32m        ).all()[m
[32m+[m[41m        [m
[32m+[m[32m        # ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜[m
[32m+[m[32m        result = [][m
[32m+[m[32m        for stat in stats:[m
[32m+[m[32m            result.append({[m
[32m+[m[32m                "skill": stat.skill,[m
[32m+[m[32m                "count": stat.count,[m
[32m+[m[32m                "job_name": stat.job_name,[m
[32m+[m[32m                "field_type": stat.field_type,[m
[32m+[m[32m                "week": stat.week,[m
[32m+[m[32m                "date": stat.date.isoformat() if stat.date else None[m
[32m+[m[32m            })[m
[32m+[m[41m        [m
[32m+[m[32m        return result[m
[32m+[m[41m        [m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        import traceback[m
[32m+[m[32m        error_detail = f"ìŠ¤í‚¬ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[32m+[m[32m        raise HTTPException(status_code=500, detail=error_detail)[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/roadmap_recommendations",[m
[32m+[m[32m    summary="ë¡œë“œë§µ ì¶”ì²œ",[m
[32m+[m[32m    description="""[m
[32m+[m[32mì‚¬ìš©ìì˜ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ì¶¤í˜• ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m- ê°­ ë¶„ì„ì„ í†µí•´ ë¶€ì¡±í•œ ìŠ¤í‚¬ì„ íŒŒì•…[m
[32m+[m[32m- íŠ¸ë Œë“œ ìŠ¤í‚¬ê³¼ ì‚¬ìš©ì ìŠ¤í‚¬ì„ ë¹„êµí•˜ì—¬ ì ìˆ˜ ê³„ì‚°[m
[32m+[m[32m- ì ìˆ˜ê°€ ë†’ì€ ë¡œë“œë§µì„ ìš°ì„ ì ìœ¼ë¡œ ì¶”ì²œ[m
[32m+[m[32m- limit íŒŒë¼ë¯¸í„°ë¡œ ê° íƒ€ì…ë³„ ì¶”ì²œ ê°œìˆ˜ ì¡°ì ˆ ê°€ëŠ¥ (ê¸°ë³¸ê°’: 10ê°œì”©, ì´ 20ê°œ)[m
[32m+[m[32m- ë¶€íŠ¸ìº í”„ limitê°œ + ê°•ì˜ limitê°œë¥¼ ë°˜í™˜[m
[32m+[m[32m- type íŒŒë¼ë¯¸í„°ë¡œ ë¶€íŠ¸ìº í”„/ê°•ì˜ í•„í„°ë§ ê°€ëŠ¥[m
[32m+[m[32m""",[m
[32m+[m[32m    response_model=List[Dict[str, Any]][m
[32m+[m[32m)[m
[32m+[m[32masync def get_roadmap_recommendations_endpoint([m
[32m+[m[32m    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    limit: int = Query(10, description="ê° íƒ€ì…ë³„ ì¶”ì²œë°›ì„ ë¡œë“œë§µ ê°œìˆ˜ (ìµœëŒ€ 20ê°œì”©, ì´ 40ê°œ)"),[m
[32m+[m[32m    type: Optional[str] = Query(None, description="í•„í„°ë§í•  íƒ€ì… (ì˜ˆ: ë¶€íŠ¸ìº í”„, ê°•ì˜)"),[m
[32m+[m[32m    db: Session = Depends(get_db),[m
[32m+[m[32m    current_user: User = Depends(get_current_user)[m
[32m+[m[32m):[m
[32m+[m[32m    """[m
[32m+[m[32m    ì‚¬ìš©ìì—ê²Œ ë§ëŠ” ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[32m+[m[32m    """[m
[32m+[m[32m    try:[m
[32m+[m[32m        # limit ê²€ì¦[m
[32m+[m[32m        if limit > 20:[m
[32m+[m[32m            limit = 20[m
[32m+[m[32m        elif limit < 1:[m
[32m+[m[32m            limit = 1[m
[32m+[m[41m            [m
[32m+[m[32m        user_id = getattr(current_user, "id", None)[m
[32m+[m[32m        if user_id is None:[m
[32m+[m[32m            raise HTTPException(status_code=400, detail="ì‚¬ìš©ì IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[32m+[m[41m        [m
[32m+[m[32m        # 1. ê°­ ë¶„ì„ ìˆ˜í–‰[m
[32m+[m[32m        gap_analysis_result = perform_gap_analysis_visualization(user_id, category, db)[m
[32m+[m[41m        [m
[32m+[m[32m        # 2. ë¡œë“œë§µ ì¶”ì²œ ìˆ˜í–‰[m
[32m+[m[32m        recommended_roadmaps = get_roadmap_recommendations([m
[32m+[m[32m            user_id=user_id,[m
[32m+[m[32m            category=category,[m
[32m+[m[32m            gap_result_text=gap_analysis_result["gap_result"],[m
[32m+[m[32m            db=db,[m
[32m+[m[32m            limit=limit[m
[32m+[m[32m        )[m
[32m+[m[41m        [m
[32m+[m[32m        # 3. typeë³„ í•„í„°ë§[m
[32m+[m[32m        if type:[m
[32m+[m[32m            filtered_roadmaps = [roadmap for roadmap in recommended_roadmaps if roadmap.get('type') == type][m
[32m+[m[32m            return filtered_roadmaps[m
[32m+[m[41m        [m
[32m+[m[32m        return recommended_roadmaps[m
[32m+[m[41m        [m
[32m+[m[32m    except ValueError as e:[m
[32m+[m[32m        raise HTTPException(status_code=404, detail=str(e))[m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        import traceback[m
[32m+[m[32m        error_detail = f"ë¡œë“œë§µ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[32m+[m[32m        raise HTTPException(status_code=500, detail=error_detail)[m
[32m+[m
[32m+[m[32m@router.get([m
[32m+[m[32m    "/roadmap_recommendations/direct",[m
[32m+[m[32m    summary="ì§ì ‘ ê°­ ë¶„ì„ ê²°ê³¼ë¡œ ë¡œë“œë§µ ì¶”ì²œ",[m
[32m+[m[32m    description="""[m
[32m+[m[32mì´ë¯¸ ìˆ˜í–‰ëœ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ì§ì ‘ ì…ë ¥ë°›ì•„ ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[32m+[m
[32m+[m[32m- ê°­ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥[m
[32m+[m[32m- ë³„ë„ì˜ ê°­ ë¶„ì„ ê³¼ì • ì—†ì´ ë°”ë¡œ ë¡œë“œë§µ ì¶”ì²œ[m
[32m+[m[32m- ê¸°ì¡´ ê°­ ë¶„ì„ ê²°ê³¼ë¥¼ ì¬í™œìš©í•  ë•Œ ìœ ìš©[m
[32m+[m[32m- limit íŒŒë¼ë¯¸í„°ë¡œ ê° íƒ€ì…ë³„ ì¶”ì²œ ê°œìˆ˜ ì¡°ì ˆ ê°€ëŠ¥ (ê¸°ë³¸ê°’: 10ê°œì”©, ì´ 20ê°œ)[m
[32m+[m[32m- ë¶€íŠ¸ìº í”„ limitê°œ + ê°•ì˜ limitê°œë¥¼ ë°˜í™˜[m
[32m+[m[32m- type íŒŒë¼ë¯¸í„°ë¡œ ë¶€íŠ¸ìº í”„/ê°•ì˜ í•„í„°ë§ ê°€ëŠ¥[m
[32m+[m[32m""",[m
[32m+[m[32m    response_model=List[Dict[str, Any]][m
[32m+[m[32m)[m
[32m+[m[32masync def get_roadmap_recommendations_direct([m
[32m+[m[32m    category: str = Query(..., description="ì§ë¬´ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì)"),[m
[32m+[m[32m    gap_result_text: str = Query(..., description="ê°­ ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸"),[m
[32m+[m[32m    limit: int = Query(10, description="ê° íƒ€ì…ë³„ ì¶”ì²œë°›ì„ ë¡œë“œë§µ ê°œìˆ˜ (ìµœëŒ€ 20ê°œì”©, ì´ 40ê°œ)"),[m
[32m+[m[32m    type: Optional[str] = Query(None, description="í•„í„°ë§í•  íƒ€ì… (ì˜ˆ: ë¶€íŠ¸ìº í”„, ê°•ì˜)"),[m
[32m+[m[32m    db: Session = Depends(get_db),[m
[32m+[m[32m    current_user: User = Depends(get_current_user)[m
[32m+[m[32m):[m
[32m+[m[32m    """[m
[32m+[m[32m    ì§ì ‘ ì…ë ¥ëœ ê°­ ë¶„ì„ ê²°ê³¼ë¡œ ë¡œë“œë§µì„ ì¶”ì²œí•©ë‹ˆë‹¤.[m
[32m+[m[32m    """[m
[32m+[m[32m    try:[m
[32m+[m[32m        # limit ê²€ì¦[m
[32m+[m[32m        if limit > 20:[m
[32m+[m[32m            limit = 20[m
[32m+[m[32m        elif limit < 1:[m
[32m+[m[32m            limit = 1[m
[32m+[m[41m            [m
[32m+[m[32m        user_id = getattr(current_user, "id", None)[m
[32m+[m[32m        if user_id is None:[m
[32m+[m[32m            raise HTTPException(status_code=400, detail="ì‚¬ìš©ì IDë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")[m
[32m+[m[41m        [m
[32m+[m[32m        # ë¡œë“œë§µ ì¶”ì²œ ìˆ˜í–‰[m
[32m+[m[32m        recommended_roadmaps = get_roadmap_recommendations([m
[32m+[m[32m            user_id=user_id,[m
[32m+[m[32m            category=category,[m
[32m+[m[32m            gap_result_text=gap_result_text,[m
[32m+[m[32m            db=db,[m
[32m+[m[32m            limit=limit[m
[32m+[m[32m        )[m
[32m+[m[41m        [m
[32m+[m[32m        # typeë³„ í•„í„°ë§[m
[32m+[m[32m        if type:[m
[32m+[m[32m            filtered_roadmaps = [roadmap for roadmap in recommended_roadmaps if roadmap.get('type') == type][m
[32m+[m[32m            return filtered_roadmaps[m
[32m+[m[41m        [m
[32m+[m[32m        return recommended_roadmaps[m
[32m+[m[41m        [m
[32m+[m[32m    except Exception as e:[m
[32m+[m[32m        import traceback[m
[32m+[m[32m        error_detail = f"ë¡œë“œë§µ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}\n\nìƒì„¸ ì •ë³´:\n{traceback.format_exc()}"[m
[32m+[m[32m        raise HTTPException(status_code=500, detail=error_detail)[m
